---
import ContentLayout from '../../layouts/ContentLayout.astro';
import PhaseIndicator from '../../components/PhaseIndicator.astro';
import StatusBadge from '../../components/StatusBadge.astro';
import TermCard from '../../components/TermCard.astro';
import { getCollection } from 'astro:content';

const { slug } = Astro.params;

const products = await getCollection('products');
const product = products.find((p) => p.id.replace(/\.md$/, '') === slug);

if (!product) {
  return Astro.redirect('/404');
}

const { Content } = await product.render();

// Get people for team member linking
const people = await getCollection('people');

// Get all definitions scoped to this product
const allDefinitions = await getCollection('definitions');
const productDefs = allDefinitions.filter((d) => d.data.product === slug);

// Get the terms that have product-specific definitions
const termSlugs = [...new Set(productDefs.map((d) => d.data.term))];
const allTerms = await getCollection('terms');
const productTerms = allTerms.filter((t) => termSlugs.includes(t.id.replace(/\.md$/, '')));

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Products', href: '/products' },
  { label: product.data.name },
];
---

<ContentLayout
  title={`${product.data.name} â€” CustDev Wiki`}
  breadcrumbs={breadcrumbs}
>
  <div class="product-header">
    <h1>{product.data.name}</h1>
    <div class="meta">
      <PhaseIndicator phase={product.data.custdev_phase} />
      <StatusBadge status={product.data.status} />
    </div>
    <p class="description">{product.data.description}</p>
  </div>

  <article class="product-content">
    <Content />
  </article>

  {productTerms.length > 0 && (
    <section class="product-terms">
      <h2>Product-Specific Terms ({productTerms.length})</h2>
      <p class="term-intro">
        These terms have definitions specific to {product.data.name}, overriding the global definitions.
      </p>
      <div class="term-grid">
        {productTerms.map((term) => (
          <TermCard
            name={term.data.name}
            slug={term.id.replace(/\.md$/, '')}
            phase={term.data.custdev_phase}
            status={term.data.status}
          />
        ))}
      </div>
    </section>
  )}

  <Fragment slot="sidebar">
    <div class="sidebar-section">
      <h3>Product Details</h3>
      <dl>
        <dt>Status</dt>
        <dd><StatusBadge status={product.data.status} /></dd>
        <dt>Phase</dt>
        <dd><PhaseIndicator phase={product.data.custdev_phase} size="small" /></dd>
        <dt>Definitions</dt>
        <dd>{productDefs.length} product-specific</dd>
        {product.data.team_members.length > 0 && (
          <>
            <dt>Team</dt>
            <dd class="team-list">
              {product.data.team_members.map((member, i) => {
                const memberPerson = people.find((p) => p.data.name === member || p.id.replace(/\.md$/, '') === member);
                return (
                  <>
                    {i > 0 && ', '}
                    {memberPerson
                      ? <a href={`/people/${memberPerson.id.replace(/\.md$/, '')}`}>{member}</a>
                      : member
                    }
                  </>
                );
              })}
            </dd>
          </>
        )}
      </dl>
    </div>
  </Fragment>
</ContentLayout>

<style>
  .product-header {
    margin-bottom: var(--space-8);
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .product-header h1 {
    margin: 0 0 var(--space-2);
  }

  .meta {
    display: flex;
    gap: var(--space-2);
    align-items: center;
    margin-bottom: var(--space-2);
  }

  .description {
    color: var(--color-text-muted);
    margin: 0;
  }

  .product-terms {
    margin-top: var(--space-8);
  }

  .term-intro {
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .term-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-4);
  }

  .sidebar-section h3 {
    margin-top: 0;
    margin-bottom: var(--space-4);
    font-size: var(--text-base);
  }

  dl {
    margin: 0;
  }

  dt {
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-top: var(--space-3);
  }

  dt:first-child {
    margin-top: 0;
  }

  dd {
    margin: var(--space-1) 0 0 0;
  }
</style>
