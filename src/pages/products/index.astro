---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProductCard from '../../components/ProductCard.astro';
import CollectionView from '../../components/CollectionView.astro';
import type { ColumnDef, FilterDef } from '../../lib/collection-view';
import { getCollection } from 'astro:content';
import { getReviewMeta, getReviewStatus } from '../../lib/review';

const products = await getCollection('products');

const phases = ['discovery', 'validation', 'creation', 'building'];
const statuses = ['active', 'sunset', 'planned'];
const reviewStatuses = ['reviewed', 'unreviewed'];

const columns: ColumnDef[] = [
  { key: 'name', label: 'Name', sortable: true, primary: true, type: 'text' },
  { key: 'custdev_phase', label: 'Phase', sortable: true, type: 'phase' },
  { key: 'status', label: 'Status', sortable: true, type: 'badge' },
  { key: 'review_status', label: 'Review', sortable: true, type: 'review', priority: 'low' },
  { key: 'description', label: 'Description', sortable: false, type: 'text', priority: 'low' },
];

const filters: FilterDef[] = [
  { key: 'custdev_phase', label: 'Phase', options: phases },
  { key: 'status', label: 'Status', options: statuses },
  { key: 'review_status', label: 'Review', options: reviewStatuses },
];

const rows = products.map((product) => ({
  ...product,
  review_status: getReviewStatus(product.data),
}));
---

<BaseLayout title="Products â€” CustDev Wiki">
  <h1>Products</h1>
  <p class="subtitle">Each product is a scoping boundary for definitions and terms.</p>

  <CollectionView
    items={rows}
    columns={columns}
    filters={filters}
    basePath="/products"
    cardMin={350}
    emptyMessage="No products configured yet."
    itemLabel="products"
  >
    {rows.map((product) => (
      <div data-cv-id={product.id.replace(/\.md$/, '')}>
        <ProductCard
          name={product.data.name}
          slug={product.id.replace(/\.md$/, '')}
          phase={product.data.custdev_phase}
          status={product.data.status}
          description={product.data.description}
          reviewed={getReviewMeta(product.data).reviewed}
        />
      </div>
    ))}
  </CollectionView>
</BaseLayout>

<style>
  .subtitle {
    color: var(--color-text-muted);
    margin-bottom: 2rem;
  }
</style>
