---
import ContentLayout from '../../layouts/ContentLayout.astro';
import StatusBadge from '../../components/StatusBadge.astro';
import { getCollection } from 'astro:content';

const { slug } = Astro.params;

const entities = await getCollection('entities');
const entity = entities.find((e) => e.id.replace(/\.md$/, '') === slug);

if (!entity) {
  return Astro.redirect('/404');
}

const { Content } = await entity.render();

const people = await getCollection('people');
const keyPeople = people.filter((person) => person.data.company === slug);

const parent = entity.data.parent
  ? entities.find((e) => e.id.replace(/\.md$/, '') === entity.data.parent)
  : undefined;

const childEntities = entities.filter((e) => e.data.parent === slug);

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Entities', href: '/entities' },
  { label: entity.data.name },
];
---

<ContentLayout title={`${entity.data.name} â€” CustDev Wiki`} breadcrumbs={breadcrumbs}>
  <div class="entity-header">
    <h1>{entity.data.name}</h1>
    <div class="meta">
      {entity.data.status && <StatusBadge status={entity.data.status} />}
      {entity.data.relationship && (
        <span class="meta-pill">{entity.data.relationship.replace(/-/g, ' ')}</span>
      )}
      {entity.data.jurisdiction && (
        <span class="meta-pill">{entity.data.jurisdiction}</span>
      )}
    </div>
    {entity.data.legal_name && (
      <p class="entity-legal">Legal name: {entity.data.legal_name}</p>
    )}
    {entity.data.entity_type && (
      <p class="entity-type">{entity.data.entity_type.replace(/-/g, ' ')}</p>
    )}
  </div>

  <article class="entity-content" data-pagefind-body>
    <Content />
  </article>

  {keyPeople.length > 0 && (
    <section class="key-people-section">
      <h2>Team ({keyPeople.length})</h2>
      <div class="people-grid">
        {keyPeople.map((person) => (
          <a href={`/people/${person.id.replace(/\.md$/, '')}`} class="person-card">
            <div class="person-name">{person.data.name}</div>
            <div class="person-role">{person.data.role}</div>
            {person.data.title && (
              <div class="person-title">{person.data.title}</div>
            )}
          </a>
        ))}
      </div>
    </section>
  )}

  {childEntities.length > 0 && (
    <section class="child-entities">
      <h2>Child Entities ({childEntities.length})</h2>
      <div class="entity-grid">
        {childEntities.map((child) => (
          <a href={`/entities/${child.id.replace(/\.md$/, '')}`} class="entity-card">
            <div class="entity-name">{child.data.name}</div>
            {child.data.relationship && (
              <div class="entity-meta">{child.data.relationship.replace(/-/g, ' ')}</div>
            )}
            {child.data.entity_type && (
              <div class="entity-type-label">{child.data.entity_type.replace(/-/g, ' ')}</div>
            )}
          </a>
        ))}
      </div>
    </section>
  )}

  <Fragment slot="sidebar">
    <div class="sidebar-section">
      <h3>Details</h3>
      <dl>
        {parent && (
          <>
            <dt>Parent</dt>
            <dd><a href={`/entities/${parent.id.replace(/\.md$/, '')}`}>{parent.data.name}</a></dd>
          </>
        )}
        {entity.data.founded && (
          <>
            <dt>Founded</dt>
            <dd>{entity.data.founded.toLocaleDateString()}</dd>
          </>
        )}
        {entity.data.dissolved && (
          <>
            <dt>Dissolved</dt>
            <dd>{entity.data.dissolved.toLocaleDateString()}</dd>
          </>
        )}
        {entity.data.website && (
          <>
            <dt>Website</dt>
            <dd>
              <a href={entity.data.website} target="_blank" rel="noopener noreferrer">
                {entity.data.website}
              </a>
            </dd>
          </>
        )}
      </dl>
    </div>

    {(parent || childEntities.length > 0) && (
      <div class="sidebar-section">
        <h3>Structure</h3>
        <dl>
          {parent && (
            <>
              <dt>Parent Entity</dt>
              <dd>
                <a href={`/entities/${parent.id.replace(/\.md$/, '')}`}>{parent.data.name}</a>
              </dd>
            </>
          )}
          {childEntities.length > 0 && (
            <>
              <dt>Child Entities</dt>
              <dd>{childEntities.length}</dd>
            </>
          )}
        </dl>
      </div>
    )}

    {keyPeople.length > 0 && (
      <div class="sidebar-section">
        <h3>Team</h3>
        <dl>
          <dt>Total Employees</dt>
          <dd>{keyPeople.length}</dd>
        </dl>
      </div>
    )}
  </Fragment>
</ContentLayout>

<style>
  .entity-header {
    margin-bottom: var(--space-8);
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .entity-header h1 {
    margin: 0 0 var(--space-2);
  }

  .meta {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: var(--space-2);
  }

  .meta-pill {
    font-size: var(--text-xs);
    padding: 0.2em 0.6em;
    border-radius: var(--radius-sm);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    color: var(--color-text-muted);
    text-transform: capitalize;
  }

  .entity-legal,
  .entity-type {
    margin: 0;
    color: var(--color-text-muted);
    font-size: var(--text-sm);
  }

  .entity-type {
    text-transform: capitalize;
  }

  .key-people-section,
  .child-entities {
    margin: var(--space-8) 0;
  }

  .people-grid,
  .entity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: var(--space-4);
    margin-top: var(--space-4);
  }

  .person-card,
  .entity-card {
    display: block;
    padding: var(--space-4);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .person-card:hover,
  .entity-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--color-link);
  }

  .person-name,
  .entity-name {
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-1);
  }

  .person-role,
  .entity-meta {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    text-transform: capitalize;
  }

  .person-title {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-style: italic;
    margin-top: var(--space-1);
  }

  .entity-type-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: capitalize;
    margin-top: var(--space-1);
  }

  .sidebar-section h3 {
    margin-top: 0;
    margin-bottom: var(--space-4);
    font-size: var(--text-base);
  }

  dl {
    margin: 0;
  }

  dt {
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin-top: var(--space-3);
  }

  dt:first-child {
    margin-top: 0;
  }

  dd {
    margin: var(--space-1) 0 0 0;
  }
</style>
