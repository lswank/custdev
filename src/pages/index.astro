---
import BaseLayout from '../layouts/BaseLayout.astro';
import PhaseIndicator from '../components/PhaseIndicator.astro';
import { getCollection } from 'astro:content';
import { getSiteConfig } from '../lib/config.js';

const config = getSiteConfig();
const terms = await getCollection('terms');
const products = await getCollection('products');
const definitions = await getCollection('definitions');
const people = await getCollection('people');
const phases = config.custdev.phases;

// Count terms per phase
const phaseCounts = phases.map((phase) => ({
  ...phase,
  count: terms.filter((t) => t.data.custdev_phase === phase.slug).length,
}));

// Phase descriptions
const phaseDescriptions: Record<string, string> = {
  discovery: 'Hypotheses',
  validation: 'Testing',
  creation: 'Proven',
  building: 'Production',
};

// Phase SVG icons (compact)
const phaseIcons: Record<string, string> = {
  discovery: '<circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>',
  validation: '<path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/><rect x="3" y="3" width="18" height="18" rx="3" fill="none" stroke="currentColor" stroke-width="2"/>',
  creation: '<path d="M12 3v18M3 12h18" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round"/>',
  building: '<rect x="4" y="10" width="16" height="11" rx="1" fill="none" stroke="currentColor" stroke-width="2"/><path d="M8 10V6a4 4 0 018 0v4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>',
};

// Health stats
const totalTerms = terms.length;
const totalDefs = definitions.length;
const activePeople = people.filter(p => p.data.status !== 'inactive').length;
const coveragePercent = totalTerms > 0
  ? Math.round((definitions.filter(d => d.data.product === 'global').length / totalTerms) * 100)
  : 0;

// Primary collections (larger cards, 2-column)
const primaryCollections = [
  { href: '/terms', label: 'Terms', desc: `${totalTerms} defined concepts`, icon: '<path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>' },
  { href: '/products', label: 'Products', desc: `${products.length} in portfolio`, icon: '<rect x="3" y="3" width="18" height="18" rx="3" fill="none" stroke="currentColor" stroke-width="2"/><path d="M3 9h18M9 3v18" stroke="currentColor" stroke-width="2"/>' },
  { href: '/people', label: 'Team', desc: `${activePeople} active members`, icon: '<circle cx="12" cy="8" r="4" fill="none" stroke="currentColor" stroke-width="2"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>' },
];

// Secondary collections (smaller cards, 4-column)
const secondaryCollections = [
  { href: '/entities', label: 'Entities', icon: '<rect x="8" y="2" width="8" height="6" rx="1" fill="none" stroke="currentColor" stroke-width="2"/><rect x="2" y="16" width="8" height="6" rx="1" fill="none" stroke="currentColor" stroke-width="2"/><rect x="14" y="16" width="8" height="6" rx="1" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 8v4M6 16v-4h12v4" stroke="currentColor" stroke-width="2"/>' },
  { href: '/repositories', label: 'Repos', icon: '<path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0020 4.77 5.07 5.07 0 0019.91 1S18.73.65 16 2.48a13.38 13.38 0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 005 4.77a5.44 5.44 0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 009 18.13V22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' },
  { href: '/adrs', label: 'ADRs', icon: '<path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" fill="none" stroke="currentColor" stroke-width="2"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>' },
  { href: '/resources', label: 'Resources', icon: '<circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>' },
  { href: '/processes', label: 'Processes', icon: '<polyline points="22 12 18 12 15 21 9 3 6 12 2 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' },
];

// Recent terms with more metadata
const recentTerms = [...terms]
  .sort((a, b) => {
    const aDate = a.data.created ? new Date(a.data.created).getTime() : 0;
    const bDate = b.data.created ? new Date(b.data.created).getTime() : 0;
    return bDate - aDate;
  })
  .slice(0, 8);

// Popular search suggestions
const popularSearches = ['MVP', 'Customer', 'Product-Market Fit', 'Validation', 'Hypothesis'];
---

<BaseLayout title={`${config.wiki.title} — ${config.company.name}`}>
  <!-- Hero with prominent search -->
  <section class="hero">
    <h1 class="hero-title">{config.wiki.title}</h1>
    <p class="hero-tagline">Customer Development knowledge base for {config.company.name}</p>

    <form class="search-form" action="/search" method="get">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
        <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <input
        type="search"
        name="q"
        placeholder="Search terms, products, people..."
        class="search-input"
        autocomplete="off"
      />
    </form>

    <div class="search-suggestions">
      <span class="suggestions-label">Popular:</span>
      {popularSearches.map((query) => (
        <a href={`/search?q=${encodeURIComponent(query)}`} class="suggestion-pill">{query}</a>
      ))}
    </div>

    <!-- Compact health metrics -->
    <div class="health-metrics">
      <span class="metric"><strong>{totalTerms}</strong> terms</span>
      <span class="metric-separator">·</span>
      <span class="metric"><strong>{coveragePercent}%</strong> coverage</span>
      <span class="metric-separator">·</span>
      <span class="metric"><strong>{activePeople}</strong> contributors</span>
    </div>
  </section>

  <!-- Compact horizontal phase flow -->
  <section class="phases">
    <h2 class="section-heading">Customer Development Process</h2>
    <div class="phase-flow">
      {phaseCounts.map((phase, idx) => (
        <>
          <a href={`/framework/${phase.slug}`} class="phase-step" style={`--phase-color: ${phase.color}`}>
            <div class="phase-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" set:html={phaseIcons[phase.slug] || ''} />
            </div>
            <div class="phase-info">
              <h3 class="phase-label">{phase.label}</h3>
              <p class="phase-desc">{phaseDescriptions[phase.slug]}</p>
              <span class="phase-count">{phase.count}</span>
            </div>
          </a>
          {idx < phaseCounts.length - 1 && (
            <svg class="phase-arrow" width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          )}
        </>
      ))}
    </div>
  </section>

  <!-- Two-tier collection grid -->
  <section class="collections">
    <h2 class="section-heading">Primary Collections</h2>
    <div class="primary-grid">
      {primaryCollections.map((col) => (
        <a href={col.href} class="primary-card">
          <div class="card-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true" set:html={col.icon} />
          </div>
          <div class="card-info">
            <h3>{col.label}</h3>
            <p>{col.desc}</p>
          </div>
        </a>
      ))}
    </div>

    <h2 class="section-heading secondary-heading">Supporting Collections</h2>
    <div class="secondary-grid">
      {secondaryCollections.map((col) => (
        <a href={col.href} class="secondary-card">
          <div class="card-icon-small">
            <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true" set:html={col.icon} />
          </div>
          <h3>{col.label}</h3>
        </a>
      ))}
    </div>
  </section>

  <!-- Recent activity feed -->
  <section class="recent-activity">
    <h2 class="section-heading">Recent Updates</h2>
    <div class="activity-feed">
      {recentTerms.map((term) => (
        <a href={`/terms/${term.id.replace(/\.md$/, '')}`} class="activity-item">
          <div class="activity-main">
            <h3 class="activity-title">{term.data.name}</h3>
            {term.data.description && (
              <p class="activity-description">{term.data.description.slice(0, 80)}{term.data.description.length > 80 ? '...' : ''}</p>
            )}
          </div>
          <div class="activity-meta">
            <PhaseIndicator phase={term.data.custdev_phase} size="small" />
            {term.data.created && (
              <time class="activity-date">
                {new Date(term.data.created).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
              </time>
            )}
          </div>
        </a>
      ))}
    </div>
    <a href="/terms" class="view-all-link">View all terms &rarr;</a>
  </section>
</BaseLayout>

<style>
  /* Hero Section */
  .hero {
    text-align: center;
    padding: var(--space-12) 0 var(--space-8);
    border-bottom: 1px solid var(--color-border);
    margin-bottom: var(--space-12);
  }

  .hero-title {
    margin: 0 0 var(--space-2);
    font-size: var(--text-3xl);
    font-weight: 700;
    color: var(--color-text);
  }

  .hero-tagline {
    margin: 0 0 var(--space-8);
    font-size: var(--text-lg);
    color: var(--color-text-muted);
  }

  /* Large search form - the primary affordance */
  .search-form {
    position: relative;
    max-width: 600px;
    margin: 0 auto var(--space-4);
  }

  .search-icon {
    position: absolute;
    left: var(--space-4);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: var(--space-4) var(--space-4) var(--space-4) calc(var(--space-4) + 28px);
    font-size: var(--text-lg);
    font-family: var(--font-body);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-lg);
    background: var(--color-bg);
    color: var(--color-text);
    outline: none;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  .search-input:focus {
    border-color: var(--color-link);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-link) 10%, transparent);
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  /* Search suggestions */
  .search-suggestions {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    flex-wrap: wrap;
    margin-bottom: var(--space-6);
  }

  .suggestions-label {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .suggestion-pill {
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-sm);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    text-decoration: none;
    color: var(--color-text);
    transition: border-color var(--transition-fast), background-color var(--transition-fast);
  }

  .suggestion-pill:hover {
    border-color: var(--color-link);
    background-color: color-mix(in srgb, var(--color-link) 8%, var(--color-bg-secondary));
    text-decoration: none;
  }

  /* Compact health metrics */
  .health-metrics {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .metric strong {
    color: var(--color-text);
    font-weight: 600;
  }

  .metric-separator {
    color: var(--color-border);
  }

  /* Section headings */
  .section-heading {
    margin: 0 0 var(--space-4);
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--color-text);
  }

  .secondary-heading {
    margin-top: var(--space-8);
    font-size: var(--text-lg);
  }

  /* Phase flow (horizontal progression) */
  .phases {
    margin-bottom: var(--space-12);
  }

  .phase-flow {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
    flex-wrap: wrap;
  }

  .phase-step {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    border: 1px solid var(--phase-color);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    background: var(--color-bg);
    transition: background-color var(--transition-fast), box-shadow var(--transition-fast);
    min-width: 180px;
  }

  .phase-step:hover {
    background-color: color-mix(in srgb, var(--phase-color) 5%, var(--color-bg));
    box-shadow: var(--shadow-sm);
    text-decoration: none;
  }

  .phase-icon {
    color: var(--phase-color);
    flex-shrink: 0;
  }

  .phase-info {
    flex: 1;
  }

  .phase-label {
    margin: 0;
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--phase-color);
  }

  .phase-desc {
    margin: 0;
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .phase-count {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-muted);
  }

  .phase-arrow {
    color: var(--color-border);
    flex-shrink: 0;
  }

  /* Collections */
  .collections {
    margin-bottom: var(--space-12);
  }

  /* Primary collection grid (2-column, larger cards) */
  .primary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-4);
  }

  .primary-card {
    display: flex;
    align-items: flex-start;
    gap: var(--space-4);
    padding: var(--space-6);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    background: var(--color-bg);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  .primary-card:hover {
    border-color: var(--color-link);
    box-shadow: var(--shadow-md);
    text-decoration: none;
  }

  .card-icon {
    flex-shrink: 0;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    background: var(--color-bg-secondary);
    color: var(--color-link);
  }

  .card-info h3 {
    margin: 0 0 var(--space-1);
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--color-text);
  }

  .card-info p {
    margin: 0;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  /* Secondary collection grid (4-column, compact) */
  .secondary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: var(--space-3);
  }

  .secondary-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-4);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    background: var(--color-bg);
    text-align: center;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  .secondary-card:hover {
    border-color: var(--color-link);
    box-shadow: var(--shadow-sm);
    text-decoration: none;
  }

  .card-icon-small {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    background: var(--color-bg-secondary);
    color: var(--color-link);
  }

  .secondary-card h3 {
    margin: 0;
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
  }

  /* Recent activity feed */
  .recent-activity {
    margin-bottom: var(--space-12);
  }

  .activity-feed {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .activity-item {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-4);
    padding: var(--space-4);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    background: var(--color-bg);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  .activity-item:hover {
    border-color: var(--color-link);
    box-shadow: var(--shadow-sm);
    text-decoration: none;
  }

  .activity-main {
    flex: 1;
    min-width: 0;
  }

  .activity-title {
    margin: 0 0 var(--space-1);
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--color-text);
  }

  .activity-description {
    margin: 0;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    line-height: 1.5;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .activity-meta {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-shrink: 0;
  }

  .activity-date {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    white-space: nowrap;
  }

  .view-all-link {
    display: inline-block;
    margin-top: var(--space-4);
    font-weight: 600;
    font-size: var(--text-sm);
    color: var(--color-link);
  }

  .view-all-link:hover {
    color: var(--color-link-hover);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero {
      padding: var(--space-8) 0 var(--space-6);
    }

    .hero-title {
      font-size: var(--text-2xl);
    }

    .hero-tagline {
      font-size: var(--text-base);
    }

    .search-input {
      font-size: var(--text-base);
    }

    .phase-flow {
      flex-direction: column;
      align-items: stretch;
    }

    .phase-arrow {
      transform: rotate(90deg);
    }

    .phase-step {
      width: 100%;
    }

    .primary-grid {
      grid-template-columns: 1fr;
    }

    .activity-item {
      flex-direction: column;
      align-items: stretch;
    }

    .activity-meta {
      margin-top: var(--space-2);
    }
  }

  @media (max-width: 480px) {
    .secondary-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .search-suggestions {
      flex-direction: column;
    }

    .health-metrics {
      flex-wrap: wrap;
    }
  }
</style>
