---
import ThemeToggle from './ThemeToggle.astro';
import { getSiteConfig } from '../lib/config.js';

interface Props {
  user?: {
    username: string;
    role: string;
  };
}

const { user } = Astro.props;
const config = getSiteConfig();
const brandName = config.company.name === 'Your Company'
  ? config.wiki.title
  : `${config.company.name} Wiki`;
---

<nav class="nav">
  <div class="nav-inner">
    <a href="/" class="nav-brand">{brandName}</a>

    <div class="nav-search">
      <svg class="nav-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <circle cx="11" cy="11" r="8" /><path d="m21 21-4.35-4.35" />
      </svg>
      <input type="search" class="nav-search-input" placeholder="Search..." aria-label="Search wiki" />
      <kbd class="nav-search-kbd" aria-hidden="true"><span class="nav-search-kbd-mod"></span>K</kbd>
    </div>

    <button class="hamburger" aria-label="Toggle menu" aria-expanded="false">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>

    <div class="nav-links">
      <a href="/terms" class="nav-link">Terms</a>
      <a href="/products" class="nav-link">Products</a>
      <a href="/people" class="nav-link">Team</a>

      <div class="nav-dropdown" data-dropdown>
        <button class="nav-dropdown-trigger nav-link" type="button" aria-expanded="false" aria-haspopup="true">
          Engineering
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 10l5 5 5-5z"/></svg>
        </button>
        <div class="nav-dropdown-menu" role="menu">
          <a href="/entities" role="menuitem">Entities</a>
          <a href="/repositories" role="menuitem">Repositories</a>
          <a href="/adrs" role="menuitem">ADRs</a>
          <a href="/resources" role="menuitem">Resources</a>
          <a href="/processes" role="menuitem">Processes</a>
        </div>
      </div>

      <ThemeToggle />

      <div class="nav-auth">
        {user ? (
          <>
            <span class="nav-user">
              {user.username}
              <span class="role-badge">{user.role}</span>
            </span>
            {user.role === 'admin' && (
              <a href="/admin" class="nav-link">Admin</a>
            )}
            <a href="/api/auth/logout" class="nav-link">Logout</a>
          </>
        ) : (
          <a href="/login" class="nav-link nav-link--signin">Sign In</a>
        )}
      </div>
    </div>
  </div>
</nav>

<script>
  // Hamburger toggle
  const hamburger = document.querySelector('.hamburger');
  const navLinks = document.querySelector('.nav-links');

  hamburger?.addEventListener('click', () => {
    const expanded = hamburger.getAttribute('aria-expanded') === 'true';
    hamburger.setAttribute('aria-expanded', String(!expanded));
    navLinks?.classList.toggle('nav-links--open');
  });

  // Click-toggle dropdown (replaces hover)
  const dropdown = document.querySelector('[data-dropdown]');
  const trigger = dropdown?.querySelector('.nav-dropdown-trigger') as HTMLButtonElement | null;
  const menu = dropdown?.querySelector('.nav-dropdown-menu');

  const openDropdown = () => {
    trigger?.setAttribute('aria-expanded', 'true');
    menu?.classList.add('nav-dropdown-menu--open');
  };

  const closeDropdown = () => {
    trigger?.setAttribute('aria-expanded', 'false');
    menu?.classList.remove('nav-dropdown-menu--open');
  };

  trigger?.addEventListener('click', (e) => {
    e.stopPropagation();
    const isOpen = trigger.getAttribute('aria-expanded') === 'true';
    isOpen ? closeDropdown() : openDropdown();
  });

  // Close on outside click
  document.addEventListener('click', (e) => {
    if (!dropdown?.contains(e.target as Node)) closeDropdown();
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeDropdown();
  });

  menu?.addEventListener('keydown', (e) => {
    const items = Array.from(menu.querySelectorAll('a'));
    const idx = items.indexOf(document.activeElement as HTMLAnchorElement);
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      items[(idx + 1) % items.length]?.focus();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      items[(idx - 1 + items.length) % items.length]?.focus();
    }
  });

  // Search input — navigate to /search on Enter
  const searchInput = document.querySelector('.nav-search-input') as HTMLInputElement | null;
  searchInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && searchInput.value.trim()) {
      window.location.href = `/search?q=${encodeURIComponent(searchInput.value.trim())}`;
    }
  });

  // Set keyboard shortcut modifier symbol based on platform
  const kbdMod = document.querySelector('.nav-search-kbd-mod');
  if (kbdMod) {
    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0 ||
                  (navigator as any).userAgentData?.platform === 'macOS';
    kbdMod.textContent = isMac ? '\u2318' : 'Ctrl+';
  }

  // Hide kbd hint when search is focused, show on blur
  const kbdHint = document.querySelector('.nav-search-kbd') as HTMLElement | null;
  searchInput?.addEventListener('focus', () => {
    if (kbdHint) kbdHint.style.display = 'none';
  });
  searchInput?.addEventListener('blur', () => {
    if (kbdHint && searchInput.value === '') kbdHint.style.display = '';
  });
</script>

<style>
  .nav {
    height: var(--nav-height);
    background: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .nav-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--space-6);
    height: 100%;
    display: flex;
    align-items: center;
    gap: var(--space-6);
  }

  .nav-brand {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-text);
    text-decoration: none;
    white-space: nowrap;
  }

  .nav-brand:hover {
    color: var(--color-link);
    text-decoration: none;
  }

  /* Search */
  .nav-search {
    position: relative;
    flex: 0 1 240px;
  }

  .nav-search-icon {
    position: absolute;
    left: var(--space-3);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    pointer-events: none;
  }

  .nav-search-input {
    width: 100%;
    padding: var(--space-2) var(--space-3) var(--space-2) var(--space-8);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    background: var(--color-bg-secondary);
    color: var(--color-text);
    font-size: var(--text-sm);
    outline: none;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  .nav-search-input::placeholder {
    color: var(--color-text-muted);
  }

  .nav-search-input:focus {
    border-color: var(--color-link);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-link) 15%, transparent);
  }

  .nav-search-kbd {
    position: absolute;
    right: var(--space-2);
    top: 50%;
    transform: translateY(-50%);
    display: inline-flex;
    align-items: center;
    gap: 1px;
    font-family: inherit;
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 1px var(--space-1);
    line-height: 1.4;
    pointer-events: none;
    user-select: none;
  }

  .nav-links {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    flex: 1;
  }

  .nav-link {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    text-decoration: none;
    white-space: nowrap;
  }

  .nav-link:hover {
    color: var(--color-link);
    text-decoration: none;
  }

  .nav-link--signin {
    padding: var(--space-1) var(--space-4);
    border: 1px solid var(--color-link);
    border-radius: var(--radius-sm);
    color: var(--color-link);
  }

  .nav-link--signin:hover {
    background: var(--color-link);
    color: var(--color-bg);
  }

  /* Dropdown — click-toggle */
  .nav-dropdown {
    position: relative;
  }

  .nav-dropdown-trigger {
    cursor: pointer;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    white-space: nowrap;
    background: none;
    border: none;
    padding: 0;
    font-family: inherit;
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
  }

  .nav-dropdown-trigger:hover {
    color: var(--color-link);
  }

  .nav-dropdown-menu {
    display: none;
    position: absolute;
    top: calc(100% + var(--space-2));
    left: 0;
    min-width: 180px;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    padding: var(--space-2) 0;
    z-index: 200;
  }

  .nav-dropdown-menu--open {
    display: block;
  }

  .nav-dropdown-menu a {
    display: block;
    padding: var(--space-2) var(--space-4);
    color: var(--color-text);
    font-size: var(--text-sm);
    text-decoration: none;
  }

  .nav-dropdown-menu a:hover,
  .nav-dropdown-menu a:focus {
    background: var(--color-bg-secondary);
    color: var(--color-link);
    text-decoration: none;
    outline: none;
  }

  .nav-auth {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: var(--space-4);
  }

  .nav-user {
    font-size: var(--text-sm);
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .role-badge {
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: var(--space-1) var(--space-2);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
  }

  .hamburger {
    display: none;
    flex-direction: column;
    gap: var(--space-1);
    background: none;
    border: none;
    cursor: pointer;
    padding: var(--space-1);
  }

  .hamburger-line {
    display: block;
    width: 22px;
    height: 2px;
    background: var(--color-text);
    border-radius: 1px;
    transition: transform var(--transition-normal), opacity var(--transition-normal);
  }

  @media (max-width: 768px) {
    .hamburger {
      display: flex;
    }

    .nav-search {
      display: none;
    }

    .nav-search-kbd {
      display: none;
    }

    .nav-links {
      display: none;
      position: absolute;
      top: var(--nav-height);
      left: 0;
      right: 0;
      flex-direction: column;
      align-items: stretch;
      background: var(--color-bg);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-4) var(--space-6);
      gap: var(--space-3);
      box-shadow: var(--shadow-lg);
    }

    .nav-links--open {
      display: flex;
    }

    .nav-auth {
      margin-left: 0;
      flex-direction: column;
      align-items: flex-start;
      padding-top: var(--space-3);
      border-top: 1px solid var(--color-border);
    }

    .nav-dropdown {
      position: static;
    }

    .nav-dropdown-trigger {
      display: none;
    }

    .nav-dropdown-menu {
      display: flex;
      flex-direction: column;
      position: static;
      background: none;
      border: none;
      border-radius: 0;
      box-shadow: none;
      padding: 0;
      min-width: unset;
    }

    .nav-dropdown-menu a {
      padding: 0;
      font-size: var(--text-sm);
      color: var(--color-text-muted);
    }

    .nav-dropdown-menu a:hover {
      background: none;
      color: var(--color-link);
    }
  }
</style>
